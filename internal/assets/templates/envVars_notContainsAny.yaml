variables:
- name: isPod
  expression: 'object.kind == "Pod"'
- name: isController
  expression: 'object.kind in ["Deployment", "ReplicaSet", "DaemonSet", "StatefulSet", "Job"]'
- name: isCronJob
  expression: 'object.kind == "CronJob"'
- name: containers
  expression: |
    variables.isPod ? object.spec.containers :
    variables.isController ? object.spec.template.spec.containers :
    variables.isCronJob ? object.spec.jobTemplate.spec.template.spec.containers :
    []
- name: hasContainers
  expression: 'variables.containers.size() > 0'
- name: initContainers
  expression: |
    variables.isPod ? (has(object.spec.initContainers) ? object.spec.initContainers : []) :
    variables.isController ? (has(object.spec.template.spec.initContainers) ? object.spec.template.spec.initContainers : []) :
    variables.isCronJob ? (has(object.spec.jobTemplate.spec.template.spec.initContainers) ? object.spec.jobTemplate.spec.template.spec.initContainers : []) :
    []
- name: hasInitContainers
  expression: 'variables.initContainers.size() > 0'
- name: ephemeralContainers
  expression: |
    variables.isPod ? (has(object.spec.ephemeralContainers) ? object.spec.ephemeralContainers : []) :
    variables.isController ? (has(object.spec.template.spec.ephemeralContainers) ? object.spec.template.spec.ephemeralContainers : []) :
    variables.isCronJob ? (has(object.spec.jobTemplate.spec.template.spec.ephemeralContainers) ? object.spec.jobTemplate.spec.template.spec.ephemeralContainers : []) :
    []
- name: hasEphemeralContainers
  expression: 'variables.ephemeralContainers.size() > 0'
- name: containerHasAnyUserConfigEnv
  expression: |
    variables.containers.exists(container,
      has(container.env) &&
      container.env.exists(envVar,
        variables.userConfig.exists(key,
          key == envVar.name && envVar.value.matches(variables.userConfig[key])
        )
      )
    )
- name: initContainerHasAnyUserConfigEnv
  expression: |
    variables.initContainers.exists(container,
      has(container.env) &&
      container.env.exists(envVar,
        variables.userConfig.exists(key,
          key == envVar.name && envVar.value.matches(variables.userConfig[key])
        )
      )
    )
- name: ephemeralContainerHasAnyUserConfigEnv
  expression: |
    variables.ephemeralContainers.exists(container,
      has(container.env) &&
      container.env.exists(envVar,
        variables.userConfig.exists(key,
          key == envVar.name && envVar.value.matches(variables.userConfig[key])
        )
      )
    )
validations:
- expression: |
    !variables.hasContainers ||
    variables.containerHasAnyUserConfigEnv
  message: 'operator: containers not_contains_any, environment variables does not use any userConfig key/value'
- expression: |
    !variables.hasInitContainers ||
    variables.initContainerHasAnyUserConfigEnv
  message: 'operator: initContainers not_contains_any, environment variables does not use any userConfig key/value'
- expression: |
    !variables.hasEphemeralContainers ||
    variables.ephemeralContainerHasAnyUserConfigEnv
  message: 'operator: ephemeralContainers not_contains_any, environment variables does not use any userConfig key/value'
