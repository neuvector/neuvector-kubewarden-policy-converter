variables:
- name: isPod
  expression: 'object.kind == "Pod"'
- name: isController
  expression: 'object.kind in ["Deployment", "ReplicaSet", "DaemonSet", "StatefulSet", "Job"]'
- name: isCronJob
  expression: 'object.kind == "CronJob"'
- name: containers
  expression: |
    variables.isPod ? object.spec.containers :
    variables.isController ? object.spec.template.spec.containers :
    variables.isCronJob ? object.spec.jobTemplate.spec.template.spec.containers :
    []
- name: hasContainers
  expression: 'variables.containers.size() > 0'
- name: initContainers
  expression: |
    variables.isPod ? (has(object.spec.initContainers) ? object.spec.initContainers : []) :
    variables.isController ? (has(object.spec.template.spec.initContainers) ? object.spec.template.spec.initContainers : []) :
    variables.isCronJob ? (has(object.spec.jobTemplate.spec.template.spec.initContainers) ? object.spec.jobTemplate.spec.template.spec.initContainers : []) :
    []
- name: hasInitContainers
  expression: 'variables.initContainers.size() > 0'
- name: ephemeralContainers
  expression: |
    variables.isPod ? (has(object.spec.ephemeralContainers) ? object.spec.ephemeralContainers : []) :
    variables.isController ? (has(object.spec.template.spec.ephemeralContainers) ? object.spec.template.spec.ephemeralContainers : []) :
    variables.isCronJob ? (has(object.spec.jobTemplate.spec.template.spec.ephemeralContainers) ? object.spec.jobTemplate.spec.template.spec.ephemeralContainers : []) :
    []
- name: hasEphemeralContainers
  expression: 'variables.ephemeralContainers.size() > 0'
- name: containerHasDisallowedEnv
  expression: |
    variables.containers.exists(container,
      has(container.env) &&
      container.env.exists(envVar,
        !variables.userConfig.exists(key,
          key == envVar.name && envVar.value.matches(variables.userConfig[key])
        )
      )
    )
- name: initContainerHasDisallowedEnv
  expression: |
    variables.initContainers.exists(container,
      has(container.env) &&
      container.env.exists(envVar,
        !variables.userConfig.exists(key,
          key == envVar.name && envVar.value.matches(variables.userConfig[key])
        )
      )
    )
- name: ephemeralContainerHasDisallowedEnv
  expression: |
    variables.ephemeralContainers.exists(container,
      has(container.env) &&
      container.env.exists(envVar,
        !variables.userConfig.exists(key,
          key == envVar.name && envVar.value.matches(variables.userConfig[key])
        )
      )
    )
validations:
- expression: |
    !variables.hasContainers ||
    !variables.containerHasDisallowedEnv
  message: 'operator: containers contains_other_than, environment variables must use only allowed key/value pairs.'
- expression: |
    !variables.hasInitContainers ||
    !variables.initContainerHasDisallowedEnv
  message: 'operator: initContainers contains_other_than, environment variables must use only allowed key/value pairs.'
- expression: |
    !variables.hasEphemeralContainers ||
    !variables.ephemeralContainerHasDisallowedEnv
  message: 'operator: ephemeralContainers contains_other_than, environment variables must use only allowed key/value pairs.'
